{% extends 'base.html' %}
{% load static %}

{% block title %}Payment - Goal Fever{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="glass-card p-5 animate-fade-in">
                <!-- Payment Header -->
                <div class="text-center mb-5">
                    <div class="payment-icon mb-4">
                        <i class="fas fa-lock fa-4x" style="color: #ffcc00;"></i>
                    </div>
                    <h1 class="gradient-text mb-3">Complete Payment</h1>
                    <p class="text-light">Submit your payment details for verification</p>
                </div>
                
                <!-- Order Summary -->
                <div class="order-summary mb-5">
                    <h4 class="gradient-text mb-4">
                        <i class="fas fa-receipt me-2"></i> Order Summary
                    </h4>
                    
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <tbody>
                                <tr>
                                    <td>Tournament:</td>
                                    <td class="text-end">
                                        <strong>{{ tournament.name }}</strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Selected Team:</td>
                                    <td class="text-end">
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-flag me-1"></i>
                                            {{ registration.selected_team.name }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Player:</td>
                                    <td class="text-end">{{ user.username }}</td>
                                </tr>
                                <tr>
                                    <td>Registration ID:</td>
                                    <td class="text-end">GF{{ registration.id }}</td>
                                </tr>
                                <tr class="table-warning">
                                    <td><strong>Amount to Pay:</strong></td>
                                    <td class="text-end">
                                        <strong class="fs-4" style="color: #000;">150৳</strong>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Payment Instructions -->
                <div class="alert alert-info glass-card border-info mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i>Payment Instructions:</h6>
                    <ol class="mb-0 small">
                        <li>Send <strong>150৳</strong> via bKash/Nagad to: <strong>01758101881</strong></li>
                        <li>Use <strong>GF{{ registration.id }}</strong> as reference</li>
                        <li>Save the transaction ID from confirmation SMS</li>
                        <li>Enter details below and submit</li>
                        <li>Admin will verify and confirm within 24 hours</li>
                    </ol>
                </div>
                
                <!-- Payment Form -->
                <form method="POST" id="paymentForm" action="{% url 'payment_page' registration.id %}">
                    {% csrf_token %}
                    
                    <!-- Payment Method Selection -->
                    <div class="mb-4">
                        <label class="form-label text-light">
                            <i class="fas fa-credit-card me-2"></i> Payment Method
                        </label>
                        <select class="form-select bg-dark text-light border-warning" 
                                name="payment_method" required id="payment_method">
                            <option value="">Select Payment Method</option>
                            <option value="bKash">bKash</option>
                            <option value="Nagad">Nagad</option>
                            <option value="Rocket">Rocket</option>
                            <option value="Bank">Bank Transfer</option>
                        </select>
                        <div class="invalid-feedback" id="payment_method_error">
                            Please select a payment method
                        </div>
                    </div>
                    
                    <!-- Mobile Number -->
                    <div class="mb-4">
                        <label class="form-label text-light">
                            <i class="fas fa-mobile-alt me-2"></i> Your Mobile Number
                        </label>
                        <input type="text" 
                               class="form-control bg-dark text-light border-warning" 
                               name="mobile_number" 
                               id="mobile_number"
                               placeholder="017XXXXXXXX"
                               required
                               pattern="[0-9]{11}"
                               title="11 digit mobile number">
                        <div class="form-text text-light">
                            <i class="fas fa-info-circle me-1"></i>
                            The number from which you sent payment
                        </div>
                        <div class="invalid-feedback" id="mobile_number_error">
                            Please enter a valid 11-digit mobile number
                        </div>
                    </div>
                    
                    <!-- Transaction ID -->
                    <div class="mb-4">
                        <label class="form-label text-light">
                            <i class="fas fa-receipt me-2"></i> Transaction ID
                        </label>
                        <input type="text" 
                               class="form-control bg-dark text-light border-warning" 
                               name="transaction_id" 
                               id="transaction_id"
                               placeholder="Enter transaction ID"
                               required>
                        <div class="form-text text-light">
                            <i class="fas fa-key me-1"></i>
                            Transaction ID from bKash/Nagad confirmation message
                        </div>
                        <div class="invalid-feedback" id="transaction_id_error">
                            Please enter a valid transaction ID (minimum 4 characters)
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-3">
                        <button type="submit" class="btn btn-gold btn-lg" id="submitBtn">
                            <i class="fas fa-paper-plane me-2"></i> Submit Payment Details
                        </button>
                        
                        <a href="{% url 'tournament_register' tournament.id %}" 
                           class="btn btn-outline-light">
                            <i class="fas fa-exchange-alt me-2"></i> Change Team
                        </a>
                        
                        <a href="{% url 'cancel_registration' registration.id %}" 
                           class="btn btn-outline-danger">
                            <i class="fas fa-times me-2"></i> Cancel Registration
                        </a>
                        
                        <div class="text-center mt-3">
                            <p class="text-light small mb-0">
                                <i class="fas fa-shield-alt me-1" style="color: #ffcc00;"></i>
                                Status: <span class="badge bg-warning">Pending Verification</span>
                            </p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .payment-icon {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .glass-card {
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 204, 0, 0.2);
        border-radius: 15px;
    }
    
    .btn-gold {
        background: linear-gradient(45deg, #ffcc00, #ff9900);
        border: none;
        color: #000;
        font-weight: bold;
    }
    
    .btn-gold:hover {
        background: linear-gradient(45deg, #ff9900, #ff6600);
        color: #000;
    }
    
    .is-invalid {
        border-color: #dc3545 !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('paymentForm');
        const submitBtn = document.getElementById('submitBtn');
        
        // Auto-focus on payment method field
        document.getElementById('payment_method').focus();
        
        // Real-time validation
        document.getElementById('mobile_number').addEventListener('input', function() {
            validateMobileNumber(this);
        });
        
        document.getElementById('transaction_id').addEventListener('input', function() {
            validateTransactionId(this);
        });
        
        document.getElementById('payment_method').addEventListener('change', function() {
            validatePaymentMethod(this);
        });
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate all fields
            const mobileValid = validateMobileNumber(document.getElementById('mobile_number'));
            const transactionValid = validateTransactionId(document.getElementById('transaction_id'));
            const paymentValid = validatePaymentMethod(document.getElementById('payment_method'));
            
            if (mobileValid && transactionValid && paymentValid) {
                // Show loading
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Submitting...';
                submitBtn.disabled = true;
                
                // Submit form
                this.submit();
            } else {
                // Scroll to first error
                const firstError = document.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            }
        });
        
        function validateMobileNumber(input) {
            const value = input.value.trim();
            const errorElement = document.getElementById('mobile_number_error');
            
            if (!/^[0-9]{11}$/.test(value)) {
                input.classList.add('is-invalid');
                errorElement.textContent = 'Please enter a valid 11-digit mobile number';
                errorElement.style.display = 'block';
                return false;
            } else {
                input.classList.remove('is-invalid');
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateTransactionId(input) {
            const value = input.value.trim();
            const errorElement = document.getElementById('transaction_id_error');
            
            if (value.length < 4) {
                input.classList.add('is-invalid');
                errorElement.textContent = 'Please enter a valid transaction ID (minimum 4 characters)';
                errorElement.style.display = 'block';
                return false;
            } else {
                input.classList.remove('is-invalid');
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validatePaymentMethod(select) {
            const value = select.value;
            const errorElement = document.getElementById('payment_method_error');
            
            if (!value) {
                select.classList.add('is-invalid');
                errorElement.style.display = 'block';
                return false;
            } else {
                select.classList.remove('is-invalid');
                errorElement.style.display = 'none';
                return true;
            }
        }
    });
</script>
{% endblock %}